<!doctype html>
<html>

<head>
    <title>CalTrans ML Stations</title>
    <meta charset="utf-8">

    <style>
        body {
            /*font-size: 12px;*/
            font-size: 24px;
        }

        text {
            fill: white;
        }

        svg {
            position: relative;
        }

        path {
            fill: #ff0000;
            fill-opacity: .7;
            /*fill-opacity: .2;*/
        }

        path:hover {
            fill: brown;
            fill-opacity: .7;
        }

        #map {
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: #333;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 120;
            height: 60;
            padding: 2px;
            font: 16px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
    </style>

    <link rel="stylesheet" href="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="//cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <script>
        $(function() {
            $("#check").button();
            $("#format").buttonset();

            console.log("1: " + $("#north_toggle").is(':checked'));
            console.log("2: " + $("#south_toggle").is(':checked'));
            console.log("3: " + $("#east_toggle").is(':checked'));
            console.log("4: " + $("#west_toggle").is(':checked'));

            // $("#check0").change(function() {
            $(".direction_toggle").change(function() {
                if ($(this).is(':checked')) {
                    console.log(true);
                } else {
                    console.log(false);
                }
            });
        });

        // $(function() {
        //     $("#file-button")
        //         .button()
        //         .click(function(event) {
        //             // event.preventDefault();
        //             // console.log("button pressed");
        //             var reader = new FileReader();
        //             var file = this.files[0];
        //             reader.readAsText(file);
        //         });
        // });
        //

        // load dataset and create table
        function load_dataset(csv) {
            var data = d3.csv.parse(csv);
            // create_table(data);
            console.log(data);
        }

        // handle upload button
        function upload_button(el, callback) {
            var uploader = document.getElementById(el);
            var reader = new FileReader();

            reader.onload = function(e) {
                var contents = e.target.result;
                callback(contents);
            };

            uploader.addEventListener("change", handleFiles, false);

            function handleFiles() {
                d3.select("#table").text("loading...");
                var file = this.files[0];
                reader.readAsText(file);
            }
        }
    </script>
    <style>
        #format {
            margin-top: 2em;
        }
    </style>

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <script src="js/leaflet-sidebar.js"></script>

    <style>
        div.sidebar-content {
            font-family: "Trebuchet MS", "Helvetica", "Arial", "Verdana", "sans-serif";
            font-size: 62.5%;
        }
    </style>

</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#load_file" role="tab"><i class="fa fa-file"></i></a></li>
                <li><a href="#filter_pane" role="tab"><i class="fa fa-check-square"></i></a></li>
                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                        sidebar-v2
                        <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                    </h1>

                <p>A responsive sidebar for mapping libraries like <a href="http://leafletjs.com/">Leaflet</a> or <a href="http://openlayers.org/">OpenLayers</a>.</p>

            </div>

            <div class="sidebar-pane" id="load_file">
                <h1 class="sidebar-header">
                            Load File
                        <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                    </h1>

                <p class="lorem">Load a CSV file.</p>
                <input type="file" id="uploader">
                <!-- <button id="file-button">Select file</button> -->
            </div>

            <div class="sidebar-pane" id="filter_pane">
                <h1 class="sidebar-header">Filters<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <input type="checkbox" id="check">
                <label for="check">Toggle</label>

                Freeway Direction:
                <div id="format">
                    <input type="checkbox" id="north_toggle" class="direction_toggle" checked="checked">
                    <label for="north_toggle"><i class="fa fa-arrow-up" aria-hidden="true"></i>
                        <br>North</label>
                    <input type="checkbox" id="south_toggle" class="direction_toggle" checked="checked">
                    <label for="south_toggle"><i class="fa fa-arrow-down" aria-hidden="true"></i>
                        <br>South</label>
                    <input type="checkbox" id="east_toggle" class="direction_toggle" checked="checked">
                    <label for="east_toggle"><i class="fa fa-arrow-right" aria-hidden="true"></i>
                        <br>East</label>
                    <input type="checkbox" id="west_toggle" class="direction_toggle" checked="checked">
                    <label for="west_toggle"><i class="fa fa-arrow-left" aria-hidden="true"></i>
                        <br>West</label>
                </div>
            </div>

            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
        </div>
    </div>

    <div id="map"></div>
    <div id="tooltip">
        <svg xmlns="http://www.w3.org/2000/svg" width="100px" height="100px" />
    </div>

    <script>
        // associate the file load button with events
        upload_button("uploader", load_dataset);

        // Define the div for the tooltip
        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        var station_data;

        function filter_stations() {
            var clone = station_data.slice(0);
            if (!($("#north_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 1;
                });
            }
            if (!($("#south_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 2;
                });
            }
            if (!($("#east_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 3;
                });
            }
            if (!($("#west_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 4;
                });
            }
            return clone;
        }

        d3.json('data/station_meta_ML.json', function(error, incidents) {

            station_data = incidents;

            function reformat(array) {
                var data = [];
                array.map(function(d, i) {

                    data.push({
                        id: +d.station,
                        name: d.name,
                        direction: +d.direction,
                        freeway: +d.freeway,
                        type: "Feature",
                        geometry: {
                            coordinates: [+d.longitude, +d.latitude],
                            type: "Point"
                        }


                    });
                });
                return data;
            }
            var geoData = {
                type: "FeatureCollection",
                // features: reformat(incidents)
                features: reformat(filter_stations())
            };



            var qtree = d3.geom.quadtree(geoData.features.map(function(data, i) {
                return {
                    x: data.geometry.coordinates[0],
                    y: data.geometry.coordinates[1],
                    all: data
                };
            }));


            // Find the nodes within the specified rectangle.
            function search(quadtree, x0, y0, x3, y3) {
                var pts = [];
                var subPixel = false;
                var subPts = [];
                var scale = getZoomScale();
                console.log(" scale: " + scale);
                var counter = 0;
                quadtree.visit(function(node, x1, y1, x2, y2) {
                    var p = node.point;
                    var pwidth = node.width * scale;
                    var pheight = node.height * scale;

                    // -- if this is too small rectangle only count the branch and set opacity
                    if ((pwidth * pheight) <= 1) {
                        // start collecting sub Pixel points
                        subPixel = true;
                    }
                    // -- jumped to super node large than 1 pixel
                    else {
                        // end collecting sub Pixel points
                        if (subPixel && subPts && subPts.length > 0) {

                            subPts[0].group = subPts.length;
                            pts.push(subPts[0]); // add only one todo calculate intensity
                            counter += subPts.length - 1;
                            subPts = [];
                        }
                        subPixel = false;
                    }

                    if ((p) && (p.x >= x0) && (p.x < x3) && (p.y >= y0) && (p.y < y3)) {

                        if (subPixel) {
                            subPts.push(p.all);
                        } else {
                            if (p.all.group) {
                                delete(p.all.group);
                            }
                            pts.push(p.all);
                        }

                    }
                    // if quad rect is outside of the search rect do nto search in sub nodes (returns true)
                    return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
                });
                console.log(" Number of removed  points: " + counter);
                return pts;

            }

            function updateNodes(quadtree) {
                var nodes = [];
                quadtree.depth = 0; // root

                quadtree.visit(function(node, x1, y1, x2, y2) {
                    var nodeRect = {
                        left: MercatorXofLongitude(x1),
                        right: MercatorXofLongitude(x2),
                        bottom: MercatorYofLatitude(y1),
                        top: MercatorYofLatitude(y2),
                    };
                    node.width = (nodeRect.right - nodeRect.left);
                    node.height = (nodeRect.top - nodeRect.bottom);

                    if (node.depth === 0) {
                        console.log(" width: " + node.width + "height: " + node.height);
                    }
                    nodes.push(node);
                    for (var i = 0; i < 4; i++) {
                        if (node.nodes[i]) node.nodes[i].depth = node.depth + 1;
                    }
                });
                return nodes;
            }

            //-------------------------------------------------------------------------------------
            MercatorXofLongitude = function(lon) {
                return lon * 20037508.34 / 180;
            };

            MercatorYofLatitude = function(lat) {
                return (Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180)) * 20037508.34 / 180;
            };
            var cscale = d3.scale.linear().domain([1, 3]).range(["#ff0000", "#ff6a00", "#ffd800", "#b6ff00", "#00ffff", "#0094ff"]); //"#00FF00","#FFA500"
            var leafletMap = L.map('map').setView([33.542674, -117.057767], 9);

            L.tileLayer("https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png").addTo(leafletMap);
            // L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png").addTo(leafletMap);
            var sidebar = L.control.sidebar('sidebar').addTo(leafletMap);

            var svg = d3.select(leafletMap.getPanes().overlayPane).append("svg");
            var g = svg.append("g").attr("class", "leaflet-zoom-hide");


            // Use Leaflet to implement a D3 geometric transformation.
            function projectPoint(x, y) {
                var point = leafletMap.latLngToLayerPoint(new L.LatLng(y, x));
                this.stream.point(point.x, point.y);
            }

            var transform = d3.geo.transform({
                point: projectPoint
            });
            var path = d3.geo.path().projection(transform);


            updateNodes(qtree);

            leafletMap.on('moveend', mapmove);

            mapmove();

            function getZoomScale() {
                var mapWidth = leafletMap.getSize().x;
                var bounds = leafletMap.getBounds();
                var planarWidth = MercatorXofLongitude(bounds.getEast()) - MercatorXofLongitude(bounds.getWest());
                var zoomScale = mapWidth / planarWidth;
                return zoomScale;

            }

            function redrawSubset(subset) {
                path.pointRadius(4); // * scale);
                var bounds = path.bounds({
                    type: "FeatureCollection",
                    features: subset
                });
                var topLeft = bounds[0];
                var bottomRight = bounds[1];


                svg.attr("width", bottomRight[0] - topLeft[0])
                    .attr("height", bottomRight[1] - topLeft[1])
                    .style("left", topLeft[0] + "px")
                    .style("top", topLeft[1] + "px");


                g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

                var start = new Date();

                var points = g.selectAll("path")
                    .data(subset, function(d) {
                        return d.id;
                    });
                points.enter().append("path");
                points.exit().remove();

                points.attr("d", path)
                    .on("mouseover", function(d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        div.html(d.id + "<br/>" + d.name + "<br/>" + d.freeway + "<br/>" + directionNames["_" + d.direction.toString()])
                            // .style("left", (d3.event.pageX) + "px")
                            .style("left", (d3.event.pageX + 10) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });

                points.style("fill-opacity", function(d) {
                    if (d.group) {
                        return (d.group * 0.1) + 0.2;
                    }
                });


                console.log("updated at  " + new Date().setTime(new Date().getTime() - start.getTime()) + " ms ");

            }

            // Mapping from direction enum to north, south, east, west
            // JSON keys cannot be a number and must start with a _ or alpha
            var directionNames = {
                "_1": "N",
                "_2": "S",
                "_3": "E",
                "_4": "W"
            };

            function mapmove(e) {
                var mapBounds = leafletMap.getBounds();
                var subset = search(qtree, mapBounds.getWest(), mapBounds.getSouth(), mapBounds.getEast(), mapBounds.getNorth());
                console.log("subset: " + subset.length);

                redrawSubset(subset);

            }
        });
    </script>
</body>

</html>
