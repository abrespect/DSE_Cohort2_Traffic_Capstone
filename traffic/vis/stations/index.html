<!doctype html>
<html>

<head>
    <title>CalTrans ML Stations</title>
    <meta charset="utf-8">

    <style>

        svg {
            position: relative;
        }

        path {
            font-size: 24px;
        }

        path:hover {
            fill: brown;
            fill-opacity: .7;
        }

        #map {
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: #333;
        }

        div.tooltip {
            position: absolute;
            text-align: center;
            width: 120;
            height: 60;
            padding: 2px;
            font: 16px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
            fill: black;
        }

        #format {
            margin-top: 2em;
        }

        div.sidebar-content {
            font-family: "Trebuchet MS", "Helvetica", "Arial", "Verdana", "sans-serif";
            font-size: 62.5%;
        }
    </style>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>

    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <script src="js/colorbar.js"></script>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" />
    <script src="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <script src="js/leaflet-sidebar.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>

    <script src="js/jquery.multiselect.js"></script>
    <link rel="stylesheet" href="css/jquery.multiselect.css" />

    <script>
        $(function() {

            resetForms();

            $("#check").button();
            $("#format").buttonset();
            $("#eig_radio").buttonset();
            $(".direction_toggle").change(function() {
                redraw();
            });

            $("#eig_radio input[type='radio']").change(function() {
                current_vec = $(this).attr('value');
                create_colors();
                update_slider();
                redraw();
            });

            $("#freeway_select").multiselect({
                selectedText: "# of # selected",
                click: function(event, ui) {
                    if (!ui.checked) {
                        delete selected_freeways[ui.value];
                        console.log("disabled freeway", ui.value);
                    } else {
                        selected_freeways[ui.value] = 1;
                        console.log("enabled freeway", ui.value);
                    }
                    update_freeway_filter();
                    redraw();
                },
                checkAll: function(event, ui) {
                    selected_freeways = jQuery.extend({}, all_freeways);
                    console.log("checkall");
                    update_freeway_filter();
                    redraw();
                },
                uncheckAll: function(event, ui) {
                    selected_freeways = {};
                    console.log("uncheckall");
                    update_freeway_filter();
                    redraw();
                },
            });

            // Get the currently selected vector.
            current_vec = $("#eig_radio input[type='radio']:checked").attr('value');

            $("#eig_radio").hide();
            $("#vec_slider").hide();
            $("#freeway_selection_div").hide();

        });
    </script>

</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#load_file" role="tab"><i class="fa fa-file"></i></a></li>
                <li><a href="#filter_pane" role="tab"><i class="fa fa-check-square"></i></a></li>
                <li><a href="#references" role="tab"><i class="fa fa-bar-chart"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                        sidebar-v2
                        <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                    </h1>

                <p>A responsive sidebar for mapping libraries like <a href="http://leafletjs.com/">Leaflet</a> or <a href="http://openlayers.org/">OpenLayers</a>.</p>

            </div>

            <div class="sidebar-pane" id="load_file">
                <h1 class="sidebar-header">
                            Load File
                        <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                    </h1>

                <p class="lorem">Load a CSV file.</p>
                <form>
                    <input type="file" id="uploader">
                    <p id="load_file_result"></p>
                </form>
            </div>

            <div class="sidebar-pane" id="filter_pane">
                <h1 class="sidebar-header">Filters<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>

                <h2 align="center">Direction Toggle</h2>
                <div id="format" align="center">
                    <input type="checkbox" id="north_toggle" class="direction_toggle" checked="checked">
                    <label for="north_toggle"><i class="fa fa-arrow-up" aria-hidden="true"></i>
                        <br>North</label>
                    <input type="checkbox" id="south_toggle" class="direction_toggle" checked="checked">
                    <label for="south_toggle"><i class="fa fa-arrow-down" aria-hidden="true"></i>
                        <br>South</label>
                    <input type="checkbox" id="east_toggle" class="direction_toggle" checked="checked">
                    <label for="east_toggle"><i class="fa fa-arrow-right" aria-hidden="true"></i>
                        <br>East</label>
                    <input type="checkbox" id="west_toggle" class="direction_toggle" checked="checked">
                    <label for="west_toggle"><i class="fa fa-arrow-left" aria-hidden="true"></i>
                        <br>West</label>
                </div>

                <form>
                    <div id="eig_radio" align="center">
                        <h2 align="center">Vector Selection</h2>
                        <input type="radio" id="v1_radio" name="radio" value="v1" checked="checked">
                        <label for="v1_radio">V1</label>
                        <input type="radio" id="v2_radio" name="radio" value="v2">
                        <label for="v2_radio">V2</label>
                    </div>
                </form>

                <div id="vec_slider">
                    <p>
                        <label for="amount">Value</label>
                        <input type="text" id="amount" readonly style="border:0; font-weight:bold;">
                    </p>

                    <div id="slider-range"></div>
                </div>

                <div id="freeway_selection_div" align="center>">
                    <h2 align="center">Freeway Selection</h2>
                    <select id="freeway_select" name="freeway_select" multiple="multiple">
                        <!-- it doesn't matter what the options are here. They will be replaced by freeway data when a file is loaded -->
                        <option value="1">Option 1</option>
                        <option value="2">Option 2</option>
                        <option value="3">Option 3</option>
                        <option value="4">Option 4</option>
                        <option value="5">Option 5</option>
                    </select>
                </div>
            </div>

            <div class="sidebar-pane" id="references">
                <h1 class="sidebar-header">Reference<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <svg width="300" height="320">
                    <g id="color_bar" v></g>
                </svg>
                <div id="barchart"></div>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
        </div>
    </div>

    <div id="map"></div>
    <div id="tooltip">
        <svg xmlns="http://www.w3.org/2000/svg" width="100px" height="100px" />
    </div>

    <script>
        var station_data,
            geoData,
            qtree,
            station_map,
            joined_data,
            color_scale,
            colorbar, pointer,
            current_vec,
            station_chart;

        var cf,
            dim_freeway,
            dim_vector,
            dim_direction,
            dim_range;

        var all_freeways,
            selected_freeways = {};

        function load_dataset(csv) {
            var new_data = [];
            try {
                vector_data = d3.csv.parseRows(csv, function(d) {
                    var station = {
                        "station": Number(d[0])
                    };

                    // The second field is the station direction. Eigenvector coefficients start at third element.
                    for (var i = 2; i < d.length; i = i + 1) {
                        var vec = i - 1;
                        station["v" + vec.toString()] = +d[i];
                    }
                    return station;
                });
            } catch (err) {
                d3.select("#load_file_result").text("Could not load file! " + err.toString());
                console.log(err);
                return;
            }

            // Join station data with vector data.
            vector_data.forEach(function(d) {
                if (!station_map.has(d.station)) {
                    console.error("Cannot find station ID " + d.station);
                } else {
                    var station = station_map.get(d.station);
                    new_data.push($.extend(d, station));
                }
            });

            joined_data = new_data;

            cf = crossfilter(joined_data);
            dim_freeway = cf.dimension(function(d) {
                return d.freeway;
            });
            dim_range = cf.dimension(function(d) {
                return d[current_vec];
            });
            dim_direction = cf.dimension(function(d) {
                return d.direction;
            });

            dim_freeway.filterFunction(function(d) {
                return d in selected_freeways;
            });

            // Determine the freeways in the dataset.
            var freeway_group = dim_freeway.group();

            all_freeways = {};
            d3.selectAll("#freeway_select option").remove();
            freeway_group.all().forEach(function(d) {
                d3.select("#freeway_select").append("option").attr("value", d.key).attr("selected", "selected").text(d.key);
                all_freeways[d.key] = 1;
            });

            selected_freeways = jQuery.extend({}, all_freeways); // shallow copy is adequate for this object

            dim_freeway.filterFunction(function(d) {
                return d in selected_freeways;
            });

            $("#freeway_select").multiselect("refresh");

            console.log("Start");
            console.log("End");

            create_colors();

            d3.select("#load_file_result").text("File load successful. Loaded " + joined_data.length + " stations.");
            redraw();

            update_slider();

            $("#eig_radio").show();
            $("#vec_slider").show();
            $("#freeway_selection_div").show();

        }

        function update_freeway_filter() {
            dim_freeway.filterFunction(function(d) {
                return d in selected_freeways;
            });
        }

        function update_slider() {
            var domain = joined_data.map(function(d) {
                return d[current_vec];
            });

            var min = d3.min(domain);
            var max = d3.max(domain);

            $("#slider-range").slider({
                range: true,
                step: 0.01,
                min: min,
                max: max,
                values: [min, max],
                slide: function(event, ui) {
                    $("#amount").val(ui.values[0].toFixed(2) + " to " + ui.values[1].toFixed(2));
                },
                stop: function(event, ui) {
                    redraw();
                }
            });
            $("#amount").val($("#slider-range").slider("values", 0).toFixed(2) +
                " to " + $("#slider-range").slider("values", 1).toFixed(2));

        }

        function create_colors() {

            var domain = joined_data.map(function(d) {
                return d[current_vec];
            });

            colorbar = Colorbar()
                .origin([15, 10])
                .barlength(300)
                .thickness(100)
                .margin({
                    top: 5,
                    right: 80,
                    bottom: 25,
                    left: 0
                })
                .orient("vertical");

            var minVal = d3.min(domain);
            var maxVal = d3.max(domain);
            var meanVal = d3.mean(domain);

            color_scale = d3.scale.linear()
                .domain([minVal, meanVal, maxVal]);

            if (current_vec === 'v1') {
                color_scale.range(["red", "yellow", "green"]);
            } else {
                color_scale.range(["#a50026", "#ffffbf", "#006837"]);
            }

            colorbar.scale(color_scale);
            pointer = d3.selectAll("#color_bar").call(colorbar);

        }

        // handle upload button
        function upload_button(el, callback) {
            var uploader = document.getElementById(el);
            var reader = new FileReader();

            reader.onload = function(e) {
                var contents = e.target.result;
                callback(contents);
            };

            uploader.addEventListener("change", handleFiles, false);

            function handleFiles() {
                d3.select("#table").text("loading...");
                var file = this.files[0];
                reader.readAsText(file);
            }
        }

        // associate the file load button with events
        upload_button("uploader", load_dataset);

        // Define the div for the tooltip
        var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);


        function filter_stations() {
            var clone;
            if (cf === undefined) {
                clone = joined_data.slice(0);
            } else {
                clone = dim_freeway.top(Infinity);
            }

            if (!($("#north_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 1;
                });
            }
            if (!($("#south_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 2;
                });
            }
            if (!($("#east_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 3;
                });
            }
            if (!($("#west_toggle").is(':checked'))) {
                clone = clone.filter(function(d) {
                    return +d.direction !== 4;
                });
            }

            if ($("#slider-range").data('ui-slider')) {
                clone = clone.filter(function(d) {
                    return d[current_vec] >= $("#slider-range").slider("values", 0) && d[current_vec] <= $("#slider-range").slider("values", 1);
                });
            }

            return clone;
        }

        function reformat(array) {
            var data = [];
            array.map(function(d, i) {

                var next = {
                    id: +d.station,
                    name: d.name,
                    direction: +d.direction,
                    freeway: +d.freeway,
                    type: "Feature",
                    geometry: {
                        coordinates: [+d.longitude, +d.latitude],
                        type: "Point"
                    }
                };
                if (d[current_vec] !== undefined) {
                    next.v1 = +d.v1;
                    next.v2 = +d.v2;
                }

                data.push(next);
            });
            return data;
        }

        function generate_geoData() {

            geoData = {
                type: "FeatureCollection",
                features: reformat(filter_stations())
            };

            qtree = d3.geom.quadtree(geoData.features.map(function(data, i) {
                return {
                    x: data.geometry.coordinates[0],
                    y: data.geometry.coordinates[1],
                    all: data
                };
            }));

        }

        // Find the nodes within the specified rectangle.
        function search(quadtree, x0, y0, x3, y3) {
            var pts = [];
            var subPixel = false;
            var subPts = [];
            var scale = getZoomScale();
            console.log(" scale: " + scale);
            var counter = 0;
            quadtree.visit(function(node, x1, y1, x2, y2) {
                var p = node.point;
                var pwidth = node.width * scale;
                var pheight = node.height * scale;

                // -- if this is too small rectangle only count the branch and set opacity
                if ((pwidth * pheight) <= 1) {
                    // start collecting sub Pixel points
                    subPixel = true;
                }
                // -- jumped to super node large than 1 pixel
                else {
                    // end collecting sub Pixel points
                    if (subPixel && subPts && subPts.length > 0) {

                        subPts[0].group = subPts.length;
                        pts.push(subPts[0]); // add only one todo calculate intensity
                        counter += subPts.length - 1;
                        subPts = [];
                    }
                    subPixel = false;
                }

                if ((p) && (p.x >= x0) && (p.x < x3) && (p.y >= y0) && (p.y < y3)) {

                    if (subPixel) {
                        subPts.push(p.all);
                    } else {
                        if (p.all.group) {
                            delete(p.all.group);
                        }
                        pts.push(p.all);
                    }

                }
                // if quad rect is outside of the search rect do nto search in sub nodes (returns true)
                return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
            });
            console.log(" Number of removed  points: " + counter);
            return pts;

        }

        MercatorXofLongitude = function(lon) {
            return lon * 20037508.34 / 180;
        };

        MercatorYofLatitude = function(lat) {
            return (Math.log(Math.tan((90 + lat) * Math.PI / 360)) / (Math.PI / 180)) * 20037508.34 / 180;
        };
        var leafletMap = L.map('map').setView([33.542674, -117.057767], 9);

        var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        });
        OpenStreetMap_BlackAndWhite.addTo(leafletMap);

        var sidebar = L.control.sidebar('sidebar').addTo(leafletMap);

        var svg = d3.select(leafletMap.getPanes().overlayPane).append("svg");
        var g = svg.append("g").attr("class", "leaflet-zoom-hide");

        // Use Leaflet to implement a D3 geometric transformation.
        function projectPoint(x, y) {
            var point = leafletMap.latLngToLayerPoint(new L.LatLng(y, x));
            this.stream.point(point.x, point.y);
        }

        var transform = d3.geo.transform({
            point: projectPoint
        });
        var path = d3.geo.path().projection(transform);

        leafletMap.on('moveend', mapmove);

        function getZoomScale() {
            var mapWidth = leafletMap.getSize().x;
            var bounds = leafletMap.getBounds();
            var planarWidth = MercatorXofLongitude(bounds.getEast()) - MercatorXofLongitude(bounds.getWest());
            var zoomScale = mapWidth / planarWidth;
            return zoomScale;

        }

        function redrawSubset(subset) {
            path.pointRadius(8); // * scale);
            var bounds = path.bounds({
                type: "FeatureCollection",
                features: subset
            });
            var topLeft = bounds[0];
            var bottomRight = bounds[1];


            svg.attr("width", bottomRight[0] - topLeft[0])
                .attr("height", bottomRight[1] - topLeft[1])
                .style("left", topLeft[0] + "px")
                .style("top", topLeft[1] + "px");


            g.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

            var start = new Date();

            var points = g.selectAll("path")
                .data(subset, function(d) {
                    return d.id;
                });
            points.enter().append("path");
            points.exit().remove();

            points.attr("d", path)
                .on("mouseover", function(d) {
                    div.transition()
                        .duration(200)
                        .style("opacity", 0.99);
                    div.html(d.id + "<br/>" + d.name + "<br/>" + d.freeway + "<br/>" + directionNames["_" + d.direction.toString()] + (d[current_vec] !== undefined ? "<br/>" + d[current_vec] : ""))
                        .style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                    if (d[current_vec] !== undefined) {
                        pointer.pointTo(d[current_vec]);
                    }
                })
                .on("mouseout", function(d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
                .on("click", function(d) {
                    station_chart = c3.generate({
                        size: {
                            width: 300,
                        },
                        bindto: '#barchart',
                        data: {
                            columns: [
                                ['data1', 30, 200, 100, 400, 150, 250],
                                ['data2', 50, 20, 10, 40, 15, 25]
                            ]
                        }
                    });
                });


            points.style("fill-opacity", function(d) {
                if (d.group) {
                    return (d.group * 0.1) + 0.2;
                }
            }).style("fill", function(d) {
                if (d[current_vec] !== undefined) {
                    return color_scale(d[current_vec]);
                } else {
                    return "blue";
                }
            });


            console.log("updated at  " + new Date().setTime(new Date().getTime() - start.getTime()) + " ms ");

        }

        // Mapping from direction enum to north, south, east, west
        // JSON keys cannot be a number and must start with a _ or alpha
        var directionNames = {
            "_1": "N",
            "_2": "S",
            "_3": "E",
            "_4": "W"
        };

        function mapmove(e) {
            var mapBounds = leafletMap.getBounds();
            var subset = search(qtree, mapBounds.getWest(), mapBounds.getSouth(), mapBounds.getEast(), mapBounds.getNorth());
            console.log("subset: " + subset.length);

            redrawSubset(subset);

        }

        function redraw() {
            generate_geoData();
            mapmove();
        }

        d3.json('data/station_meta_ML.json', function(error, incidents) {
            // save the original stations data
            joined_data = incidents;

            // Create a mapping of station_id -> object
            station_map = new Map();
            incidents.forEach(function(s) {
                station_map.set(s.station, s);
            });

            redraw();
        });

        function resetForms() {
            for (i = 0; i < document.forms.length; i++) {
                document.forms[i].reset();
            }
        }
    </script>
</body>

</html>
